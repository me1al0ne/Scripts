-- Mobile ESP Script with Camera Lock
-- Place this in StarterPlayerScripts

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- Local Player
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- ESP Settings
local ESP_ENABLED = true
local TRACK_ALL_PLAYERS = false -- Set to true to track everyone, false for enemies only
local MAX_DISTANCE = 500 -- Max distance to show ESP
local REFRESH_RATE = 0.1 -- Update rate in seconds

-- Camera Lock Settings
local CAMERA_LOCK_ENABLED = false
local LOCKED_PLAYER = nil
local LOCKED_CHARACTER = nil
local AUTO_LOCK_RANGE = 100 -- Studs
local SMOOTHNESS = 0.2 -- Camera smoothness (0-1)

-- UI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MobileESP"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Toggle Button for Camera Lock
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "CameraLockToggle"
ToggleButton.Size = UDim2.new(0, 100, 0, 50)
ToggleButton.Position = UDim2.new(0.8, 0, 0.8, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
ToggleButton.BackgroundTransparency = 0.3
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.Text = "ðŸ”’\nLock Off"
ToggleButton.TextSize = 14
ToggleButton.BorderSizePixel = 0
ToggleButton.ZIndex = 100
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Parent = ScreenGui

-- Make button draggable
local dragging = false
local dragInput, dragStart, startPos

ToggleButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = ToggleButton.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

ToggleButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        local delta = input.Position - dragStart
        ToggleButton.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- Function to check if we should track a player
function shouldTrackPlayer(player)
    if player == LocalPlayer then
        return false
    end
    
    if TRACK_ALL_PLAYERS then
        return true
    end
    
    -- Check if both players are on teams
    local localTeam = LocalPlayer.Team
    local playerTeam = player.Team
    
    -- If no teams are set up, track everyone (or adjust as needed)
    if not localTeam or not playerTeam then
        return true
    end
    
    -- Only track if on opposite teams
    return localTeam ~= playerTeam
end

-- Toggle Camera Lock function
ToggleButton.Activated:Connect(function()
    if CAMERA_LOCK_ENABLED then
        -- Turn off lock
        CAMERA_LOCK_ENABLED = false
        LOCKED_PLAYER = nil
        LOCKED_CHARACTER = nil
        ToggleButton.Text = "ðŸ”’\nLock Off"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    else
        -- Find closest VISIBLE enemy to lock onto
        local closestPlayer = nil
        local closestDistance = math.huge
        
        for _, player in pairs(Players:GetPlayers()) do
            if shouldTrackPlayer(player) and player.Character then
                local humanoid = player.Character:FindFirstChild("Humanoid")
                local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
                
                if humanoid and humanoid.Health > 0 and rootPart then
                    local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
                    
                    -- Only lock if player is visible
                    if distance < closestDistance and distance <= AUTO_LOCK_RANGE then
                        -- Check if visible
                        local visible = isVisible(rootPart.Position, player.Character)
                        
                        if visible then
                            closestDistance = distance
                            closestPlayer = player
                        end
                    end
                end
            end
        end
        
        if closestPlayer then
            CAMERA_LOCK_ENABLED = true
            LOCKED_PLAYER = closestPlayer
            LOCKED_CHARACTER = closestPlayer.Character
            ToggleButton.Text = "ðŸ”“\nLock On"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
        else
            -- No visible enemy found
            ToggleButton.Text = "âŒ\nNo Target"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
            
            -- Reset after 1 second
            task.wait(1)
            if not CAMERA_LOCK_ENABLED then
                ToggleButton.Text = "ðŸ”’\nLock Off"
                ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            end
        end
    end
end)

-- ESP Data Storage
local ESPData = {}

-- Function to check if player is visible
function isVisible(targetPosition, character)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {character, LocalPlayer.Character}
    raycastParams.IgnoreWater = true
    
    local direction = (targetPosition - Camera.CFrame.Position).Unit
    local distance = (targetPosition - Camera.CFrame.Position).Magnitude
    local raycastResult = Workspace:Raycast(Camera.CFrame.Position, direction * distance, raycastParams)
    
    return raycastResult == nil
end

-- Function to create ESP for a player
function createESP(player)
    -- Only create ESP if we should track this player
    if not shouldTrackPlayer(player) then
        return
    end
    
    if ESPData[player] then return end
    
    ESPData[player] = {
        Box = nil,
        Label = nil,
        Tracer = nil,
        Highlight = nil,
        Character = nil
    }
    
    -- Create Highlight
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    
    -- Set color based on team
    if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
        highlight.FillColor = Color3.fromRGB(50, 150, 255) -- Blue for teammates
    else
        highlight.FillColor = Color3.fromRGB(255, 50, 50) -- Red for enemies
    end
    
    highlight.FillTransparency = 0.7
    highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
    highlight.OutlineTransparency = 0
    highlight.Enabled = false
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = nil
    
    -- Create ESP Box
    local box = Instance.new("BillboardGui")
    box.Name = "ESPBox"
    box.Size = UDim2.new(4, 0, 6, 0)
    box.AlwaysOnTop = true
    box.StudsOffset = Vector3.new(0, 3, 0)
    box.MaxDistance = MAX_DISTANCE
    box.Adornee = nil
    box.Enabled = false
    box.Parent = nil
    
    local boxFrame = Instance.new("Frame")
    boxFrame.Name = "BoxFrame"
    boxFrame.Size = UDim2.new(1, 0, 1, 0)
    
    -- Set color based on team
    if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
        boxFrame.BackgroundColor3 = Color3.fromRGB(50, 150, 255) -- Blue for teammates
    else
        boxFrame.BackgroundColor3 = Color3.fromRGB(255, 50, 50) -- Red for enemies
    end
    
    boxFrame.BackgroundTransparency = 0.7
    boxFrame.BorderSizePixel = 2
    boxFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
    boxFrame.Parent = box
    
    -- Create Info Label
    local label = Instance.new("BillboardGui")
    label.Name = "ESPInfo"
    label.Size = UDim2.new(0, 200, 0, 50)
    label.AlwaysOnTop = true
    label.StudsOffset = Vector3.new(0, 5, 0)
    label.MaxDistance = MAX_DISTANCE
    label.Adornee = nil
    label.Enabled = false
    label.Parent = nil
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Name = "InfoText"
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    textLabel.TextStrokeTransparency = 0.5
    textLabel.TextSize = 14
    textLabel.Font = Enum.Font.GothamBold
    textLabel.Text = ""
    textLabel.TextYAlignment = Enum.TextYAlignment.Bottom
    textLabel.Parent = label
    
    -- Create Tracer
    local tracer = Instance.new("Frame")
    tracer.Name = "ESPTracer"
    tracer.Size = UDim2.new(0, 2, 0, 2)
    tracer.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    tracer.BorderSizePixel = 0
    tracer.Visible = false
    tracer.Parent = ScreenGui
    
    ESPData[player].Highlight = highlight
    ESPData[player].Box = box
    ESPData[player].Label = label
    ESPData[player].Tracer = tracer
    
    -- Track character
    if player.Character then
        ESPData[player].Character = player.Character
        attachESP(player, player.Character)
    end
    
    player.CharacterAdded:Connect(function(character)
        ESPData[player].Character = character
        attachESP(player, character)
        
        -- Update camera lock target if needed
        if player == LOCKED_PLAYER then
            LOCKED_CHARACTER = character
        end
    end)
    
    player.CharacterRemoving:Connect(function()
        ESPData[player].Character = nil
        clearESP(player)
        
        -- Clear camera lock if target dies
        if player == LOCKED_PLAYER then
            CAMERA_LOCK_ENABLED = false
            LOCKED_PLAYER = nil
            LOCKED_CHARACTER = nil
            ToggleButton.Text = "ðŸ”’\nLock Off"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        end
    end)
    
    -- Track team changes
    player:GetPropertyChangedSignal("Team"):Connect(function()
        -- If team changes and we shouldn't track anymore, clear ESP
        if not shouldTrackPlayer(player) then
            clearESP(player)
            
            -- Also clear camera lock if locked on this player
            if player == LOCKED_PLAYER then
                CAMERA_LOCK_ENABLED = false
                LOCKED_PLAYER = nil
                LOCKED_CHARACTER = nil
                ToggleButton.Text = "ðŸ”’\nLock Off"
                ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
            end
        else
            -- If we should track and ESP doesn't exist, create it
            if not ESPData[player] and player.Character then
                -- Recreate ESP for this player
                createESP(player)
            end
        end
    end)
end

function attachESP(player, character)
    local humanoid = character:WaitForChild("Humanoid", 5)
    local rootPart = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Head")
    
    if humanoid and rootPart then
        ESPData[player].Highlight.Adornee = character
        ESPData[player].Highlight.Parent = character
        ESPData[player].Highlight.Enabled = true
        
        ESPData[player].Box.Adornee = rootPart
        ESPData[player].Box.Parent = rootPart
        ESPData[player].Box.Enabled = true
        
        ESPData[player].Label.Adornee = rootPart
        ESPData[player].Label.Parent = rootPart
        ESPData[player].Label.Enabled = true
    end
end

function clearESP(player)
    if ESPData[player] then
        if ESPData[player].Highlight then
            ESPData[player].Highlight:Destroy()
        end
        if ESPData[player].Box then
            ESPData[player].Box:Destroy()
        end
        if ESPData[player].Label then
            ESPData[player].Label:Destroy()
        end
        if ESPData[player].Tracer then
            ESPData[player].Tracer:Destroy()
        end
        ESPData[player] = nil
    end
end

function updateESP()
    for player, data in pairs(ESPData) do
        if player and data.Character and data.Character.Parent then
            local humanoid = data.Character:FindFirstChild("Humanoid")
            local rootPart = data.Character:FindFirstChild("HumanoidRootPart") or data.Character:FindFirstChild("Head")
            
            if humanoid and rootPart and humanoid.Health > 0 then
                -- Calculate distance
                local distance = (rootPart.Position - Camera.CFrame.Position).Magnitude
                
                if distance <= MAX_DISTANCE then
                    -- Check visibility
                    local visible = isVisible(rootPart.Position, data.Character)
                    
                    -- Update colors based on team and visibility
                    local color
                    if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                        color = Color3.fromRGB(50, 150, 255) -- Blue for teammates
                    else
                        -- Red for enemies, green if visible
                        color = visible and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
                    end
                    
                    -- Update box color
                    if data.Box and data.Box:FindFirstChild("BoxFrame") then
                        data.Box.BoxFrame.BackgroundColor3 = color
                        data.Box.BoxFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
                    end
                    
                    -- Update highlight color
                    if data.Highlight then
                        data.Highlight.FillColor = color
                        data.Highlight.Enabled = true
                    end
                    
                    -- Update label text
                    if data.Label and data.Label:FindFirstChild("InfoText") then
                        local teamText = ""
                        if player.Team then
                            teamText = player.Team.Name .. " | "
                        end
                        
                        local info = string.format("[%s]\n%sDistance: %.1f studs\nHP: %.0f/%.0f\n%s",
                            player.Name,
                            teamText,
                            distance,
                            humanoid.Health,
                            humanoid.MaxHealth,
                            visible and "Visible" or "Behind Wall"
                        )
                        data.Label.InfoText.Text = info
                        data.Label.InfoText.TextColor3 = color
                    end
                    
                    -- Update tracer
                    if data.Tracer then
                        local screenPoint, onScreen = Camera:WorldToViewportPoint(rootPart.Position)
                        if onScreen then
                            data.Tracer.Visible = visible
                            data.Tracer.Position = UDim2.new(0, screenPoint.X, 0, screenPoint.Y)
                            data.Tracer.BackgroundColor3 = color
                        else
                            data.Tracer.Visible = false
                        end
                    end
                    
                    -- Enable ESP
                    if data.Box then data.Box.Enabled = true end
                    if data.Label then data.Label.Enabled = true end
                else
                    -- Disable ESP if too far
                    if data.Box then data.Box.Enabled = false end
                    if data.Label then data.Label.Enabled = false end
                    if data.Tracer then data.Tracer.Visible = false end
                    if data.Highlight then data.Highlight.Enabled = false end
                end
            else
                -- Disable ESP if dead
                if data.Box then data.Box.Enabled = false end
                if data.Label then data.Label.Enabled = false end
                if data.Tracer then data.Tracer.Visible = false end
                if data.Highlight then data.Highlight.Enabled = false end
            end
        end
    end
end

-- Camera Lock Update Function
function updateCameraLock()
    if CAMERA_LOCK_ENABLED and LOCKED_PLAYER and LOCKED_CHARACTER then
        local humanoid = LOCKED_CHARACTER:FindFirstChild("Humanoid")
        local torso = LOCKED_CHARACTER:FindFirstChild("HumanoidRootPart") or LOCKED_CHARACTER:FindFirstChild("UpperTorso")
        
        if humanoid and humanoid.Health > 0 and torso then
            -- Smooth camera movement (stays locked even if behind walls)
            local currentCF = Camera.CFrame
            local targetPosition = torso.Position + Vector3.new(0, 2, 0)
            local targetCF = CFrame.new(Camera.CFrame.Position, targetPosition)
            
            Camera.CFrame = currentCF:Lerp(targetCF, SMOOTHNESS)
        else
            -- Target died or missing
            CAMERA_LOCK_ENABLED = false
            LOCKED_PLAYER = nil
            LOCKED_CHARACTER = nil
            ToggleButton.Text = "ðŸ”’\nLock Off"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        end
    end
end

-- Initialize ESP for existing players
function initializeESP()
    for _, player in pairs(Players:GetPlayers()) do
        if shouldTrackPlayer(player) then
            createESP(player)
        end
    end
end

-- Player Added/Removed Events
Players.PlayerAdded:Connect(function(player)
    if shouldTrackPlayer(player) then
        createESP(player)
    end
end)

Players.PlayerRemoving:Connect(function(player)
    clearESP(player)
    if player == LOCKED_PLAYER then
        CAMERA_LOCK_ENABLED = false
        LOCKED_PLAYER = nil
        LOCKED_CHARACTER = nil
        ToggleButton.Text = "ðŸ”’\nLock Off"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    end
end)

-- Local player team change event
LocalPlayer:GetPropertyChangedSignal("Team"):Connect(function()
    -- Reinitialize ESP for all players based on new team
    for player, _ in pairs(ESPData) do
        clearESP(player)
    end
    
    -- Wait a bit for team changes to propagate
    task.wait(0.1)
    
    -- Recreate ESP for players we should track
    for _, player in pairs(Players:GetPlayers()) do
        if shouldTrackPlayer(player) then
            createESP(player)
        end
    end
    
    -- Clear camera lock if locked on a player who is now on our team
    if LOCKED_PLAYER and not shouldTrackPlayer(LOCKED_PLAYER) then
        CAMERA_LOCK_ENABLED = false
        LOCKED_PLAYER = nil
        LOCKED_CHARACTER = nil
        ToggleButton.Text = "ðŸ”’\nLock Off"
        ToggleButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    end
end)

-- Main loop
local lastUpdate = 0
RunService.RenderStepped:Connect(function(deltaTime)
    lastUpdate = lastUpdate + deltaTime
    
    if lastUpdate >= REFRESH_RATE then
        if ESP_ENABLED then
            updateESP()
        end
        
        updateCameraLock()
        lastUpdate = 0
    end
end)

-- Initialize
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
initializeESP()

print("Mobile ESP with Camera Lock loaded successfully!")
print("Features:")
print("- ESP with distance, HP, and visibility")
print("- Team recognition (only shows enemies)")
print("- Avatar highlighting with team colors")
print("- Auto-retrack respawned/joined players")
print("- Mobile camera lock toggle (movable button)")
print("- Camera lock only on visible enemies, stays locked until target dies or unlock")

-- Return cleanup function
return function()
    for player, _ in pairs(ESPData) do
        clearESP(player)
    end
    ScreenGui:Destroy()
end
